#!/usr/bin/env ruby
# encoding: utf-8

require 'hashr'
require 'open-uri'
require 'yaml'
require 'right_aws'

class EC2
  def initialize(access_key_id, access_key, options = {})
    @ec2 = RightAws::Ec2.new(access_key_id, access_key, options)
  end

  def revoke(group, ip)
    cidrip = cidrip(ip)
    return unless include?(group, cidrip)
    
    puts "Revoking #{ip} ..."
    @ec2.revoke_security_group_IP_ingress(group, 22, 22, 'tcp', cidrip)
  end

  def authorize(group, ip)
    cidrip = cidrip(ip)
    return if include?(group, cidrip)
    
    puts "Authorizing #{ip} ..."
    @ec2.authorize_security_group_IP_ingress(group, 22, 22, 'tcp', cidrip)
  end

private
  def include?(group, ip)
    group = @ec2.describe_security_groups.detect { |g| g[:aws_group_name] == group }
    
    group[:aws_perms].any? { |p| p[:cidr_ips] == ip }
  end

  def cidrip(ip)
    "#{ip}/32"
  end
end

file = File.join(File.dirname(__FILE__), 'ec2.yml')

config = Hashr.new(if File.exist?(file)
  YAML.load(File.open(file, 'r'))
end)

prompt = proc do |message, default = nil|
  print(message)
  print(" [#{default}]") if default
  print(': ')
  
  value = STDIN.readline.chomp
  value = default or raise("#{message} not provided!") if value.strip.empty?
  value
end

unless config.credentials?
  puts 'Please provide your AWS credentials'
  
  config.credentials = Hashr.new(
    group:         prompt.call('Database Security Group', 'heroku'),
    region:        prompt.call('Region', 'eu-west-1'),
    access_key_id: prompt.call('Access Key ID'),
    access_key:    prompt.call('Access Key')
  )
end

begin
  last_ip = config.last_ip
  config.last_ip = current_ip = open('http://automation.whatismyip.com/n09230945.asp').read
  
  ec2 = EC2.new(config.credentials.access_key_id, config.credentials.access_key, region: config.credentials.region, logger: Logger.new('/tmp/ec2.log'))
  
  ec2.revoke(config.credentials.group, last_ip)
  ec2.authorize(config.credentials.group, current_ip)
  
  # Everything was ok, config seems to be valid -> store it!
  YAML.dump(config.to_hash, File.open(file, 'w+'))
rescue => ex
  puts ex
end
